// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  relationMode = "prisma" // Usa Prisma para relaciones, no foreign keys en DB
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique @db.VarChar(255)
  password      String    @db.VarChar(255)
  name          String?   @db.VarChar(255)
  image         String?   @db.VarChar(255)
  emailVerified DateTime? @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  roles         UserRole[]
  accounts      Account[]
  sessions      Session[]
  adminProfile  AdminProfile?
  userPreferences UserPreference?
  subscriptions Subscription[]
  workouts      Workout[]
  rmRecords     RMRecord[]
  userProgress  UserProgress[]
  paymentHistory PaymentHistory[]
  coachProfile  CoachProfile?
  studentRelationships CoachStudentRelationship[] @relation("StudentRelationships")
  adminAssignments AdminUserAssignment[]

  @@map("users")
}

model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  role      String   @default("user") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_roles_simple")
}

model Account {
  id                Int       @id @default(autoincrement())
  userId            Int       @map("user_id")
  type              String?   @db.VarChar(50)
  provider          String?   @db.VarChar(50)
  providerAccountId String?   @map("provider_account_id") @db.VarChar(255)
  refreshToken      String?   @db.Text
  accessToken       String?   @db.Text
  expiresAt         Int?
  tokenType         String?   @map("token_type") @db.VarChar(50)
  scope             String?   @db.Text
  idToken           String?   @map("id_token") @db.Text
  sessionState      String?   @map("session_state") @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Session {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  expiresAt DateTime  @map("expires_at")
  token     String    @unique @db.VarChar(255)
  ipAddress String?   @map("ip_address") @db.VarChar(45)
  userAgent String?   @map("user_agent") @db.Text
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

model AdminProfile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments AdminUserAssignment[]

  @@map("admin_profiles")
}

model AdminUserAssignment {
  id        Int      @id @default(autoincrement())
  adminId   Int      @map("admin_id")
  userId    Int      @map("user_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  admin     AdminProfile @relation(fields: [adminId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([adminId, userId])
  @@map("admin_user_assignments")
}

model Discipline {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  color       String   @default("#3B82F6") @db.VarChar(7)
  coachId     Int      @map("coach_id")
  orderIndex  Int      @default(0) @map("order_index")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  levels      DisciplineLevel[]
  planifications Planification[]

  @@map("disciplines")
}

model DisciplineLevel {
  id           Int      @id @default(autoincrement())
  disciplineId Int      @map("discipline_id")
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  orderIndex   Int      @default(0) @map("order_index")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  discipline   Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  planifications Planification[]

  @@map("discipline_levels")
}

model SubscriptionPlan {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("ARS") @db.VarChar(10)
  interval    String   @default("month") @db.VarChar(20)
  features    Json?
  isActive    Boolean  @default(true) @map("is_active")
  planType    String?  @default("student") @map("plan_type") @db.VarChar(20)
  isCoachPlan Boolean  @default(false) @map("is_coach_plan")
  coachId     Int?     @map("coach_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  coach       CoachProfile? @relation(fields: [coachId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                  Int       @id @default(autoincrement())
  userId              Int       @map("user_id")
  planId              Int       @map("plan_id")
  status              String    @default("active") @db.VarChar(20)
  currentPeriodStart  DateTime  @map("current_period_start")
  currentPeriodEnd    DateTime  @map("current_period_end")
  cancelAtPeriodEnd   Boolean   @default(false) @map("cancel_at_period_end")
  mercadopagoPaymentId String?  @map("mercadopago_payment_id") @db.VarChar(255)
  coachId             Int?      @map("coach_id")
  paymentMethod       String?   @map("payment_method") @db.VarChar(50)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at")

  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                SubscriptionPlan @relation(fields: [planId], references: [id])
  paymentHistory      PaymentHistory[]
  coachCommissions    CoachCommission[]

  @@map("subscriptions")
}

model UserPreference {
  id                    Int       @id @default(autoincrement())
  userId                Int       @unique @map("user_id")
  preferredDisciplineId Int?      @map("preferred_discipline_id")
  preferredLevelId      Int?      @map("preferred_level_id")
  lastPreferenceChangeDate DateTime? @map("last_preference_change_date")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Planification {
  id                Int       @id @default(autoincrement())
  disciplineId       Int?      @map("discipline_id")
  disciplineLevelId  Int?      @map("discipline_level_id")
  coachId            Int       @map("coach_id")
  date               DateTime  @db.Date
  title              String?   @db.VarChar(255)
  description        String?   @db.Text
  exercises          Json?
  notes              String?   @db.Text
  isCompleted        Boolean   @default(false) @map("is_completed")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at")

  discipline         Discipline? @relation(fields: [disciplineId], references: [id])
  disciplineLevel    DisciplineLevel? @relation(fields: [disciplineLevelId], references: [id])
  coach              CoachProfile @relation(fields: [coachId], references: [id])
  workouts           Workout[]
  userProgress       UserProgress[]

  @@map("planifications")
}

model Workout {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  planificationId Int?      @map("planification_id")
  data            Json?
  completedAt     DateTime? @map("completed_at")
  durationSeconds Int?      @map("duration_seconds")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  planification   Planification? @relation(fields: [planificationId], references: [id])

  @@map("workouts")
}

model RMRecord {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  exercise        String    @db.VarChar(255)
  weight          Decimal   @db.Decimal(10, 2)
  recordedAt      DateTime  @default(now()) @map("recorded_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rm_records")
}

model UserProgress {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  planificationId Int?    @map("planification_id")
  coachId       Int?      @map("coach_id")
  progressData  Json?     @map("progress_data")
  notes         String?   @db.Text
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  planification Planification? @relation(fields: [planificationId], references: [id])

  @@unique([userId, planificationId])
  @@map("user_progress")
}

model PaymentHistory {
  id                    Int       @id @default(autoincrement())
  userId                Int       @map("user_id")
  subscriptionId        Int?      @map("subscription_id")
  amount                Decimal   @db.Decimal(10, 2)
  currency              String    @default("ARS") @db.VarChar(10)
  status                String    @default("pending") @db.VarChar(20)
  mercadopagoPreferenceId String? @map("mercadopago_preference_id") @db.VarChar(255)
  mercadopagoPaymentId  String?  @map("mercadopago_payment_id") @db.VarChar(255)
  paymentMethod         String?   @map("payment_method") @db.VarChar(50)
  recipientType         String?   @map("recipient_type") @db.VarChar(20) // 'platform', 'coach', 'student'
  recipientId           Int?      @map("recipient_id") // ID del coach si recipientType = 'coach'
  splitAmount           Decimal?  @map("split_amount") @db.Decimal(10, 2) // Monto espec√≠fico si es split payment
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id])

  @@map("payment_history")
}

model CoachProfile {
  id                    Int       @id @default(autoincrement())
  userId                Int       @unique @map("user_id")
  businessName          String?   @map("business_name") @db.VarChar(255)
  phone                 String?   @db.VarChar(50)
  address               String?   @db.Text
  maxStudents           Int       @default(10) @map("max_students")
  currentStudentCount   Int       @default(0) @map("current_student_count")
  commissionRate        Decimal   @default(88.00) @map("commission_rate") @db.Decimal(5, 2) // % que recibe el COACH
  platformCommissionRate Decimal  @default(12.00) @map("platform_commission_rate") @db.Decimal(5, 2) // % que recibe la PLATAFORMA
  totalEarnings         Decimal   @default(0.00) @map("total_earnings") @db.Decimal(10, 2)
  mercadopagoAccountId String?   @map("mercadopago_account_id") @db.VarChar(255) // Account ID de MercadoPago para split de pagos
  mercadoPagoAccessToken String?  @map("mercadopago_access_token") @db.Text // Access token del coach obtenido via OAuth
  trialEndsAt           DateTime? @map("trial_ends_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")

  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions       CoachSubscription[]
  studentRelationships CoachStudentRelationship[] @relation("CoachRelationships")
  commissions         CoachCommission[]
  subscriptionPlans   SubscriptionPlan[]
  planifications      Planification[]

  @@map("coach_profiles")
}

model CoachPlanType {
  id            Int      @id @default(autoincrement())
  name          String   @unique @db.VarChar(50)
  displayName   String   @map("display_name") @db.VarChar(100)
  minStudents   Int      @map("min_students")
  maxStudents   Int      @map("max_students")
  basePrice     Decimal  @map("base_price") @db.Decimal(10, 2)
  commissionRate Decimal @map("commission_rate") @db.Decimal(5, 2)
  features      Json?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  subscriptions CoachSubscription[]

  @@map("coach_plan_types")
}

model CoachSubscription {
  id                  Int       @id @default(autoincrement())
  coachId             Int       @map("coach_id")
  planId              Int       @map("plan_id")
  status              String    @default("active") @db.VarChar(20)
  currentPeriodStart  DateTime  @map("current_period_start")
  currentPeriodEnd    DateTime  @map("current_period_end")
  cancelAtPeriodEnd   Boolean   @default(false) @map("cancel_at_period_end")
  mercadopagoPaymentId String?  @map("mercadopago_payment_id") @db.VarChar(255)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at")

  coach               CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  plan                CoachPlanType @relation(fields: [planId], references: [id])

  @@map("coach_subscriptions")
}

model CoachStudentRelationship {
  id        Int       @id @default(autoincrement())
  coachId   Int       @map("coach_id")
  studentId Int       @map("student_id")
  status    String    @default("active") @db.VarChar(20)
  joinedAt  DateTime  @default(now()) @map("joined_at")
  removedAt DateTime? @map("removed_at")

  coach     CoachProfile @relation("CoachRelationships", fields: [coachId], references: [id], onDelete: Cascade)
  student   User         @relation("StudentRelationships", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([coachId, studentId])
  @@map("coach_student_relationships")
}

model CoachCommission {
  id                        Int       @id @default(autoincrement())
  coachId                   Int       @map("coach_id")
  studentSubscriptionId     Int       @map("student_subscription_id")
  studentId                 Int       @map("student_id")
  commissionAmount          Decimal   @map("commission_amount") @db.Decimal(10, 2) // Dinero que recibe el COACH
  commissionRate            Decimal   @map("commission_rate") @db.Decimal(5, 2) // % del coach
  platformCommissionAmount  Decimal?  @map("platform_commission_amount") @db.Decimal(10, 2) // Dinero que recibe la PLATAFORMA
  platformCommissionRate    Decimal?  @map("platform_commission_rate") @db.Decimal(5, 2) // % de la plataforma
  studentSubscriptionAmount Decimal   @map("student_subscription_amount") @db.Decimal(10, 2)
  periodStart               DateTime  @map("period_start")
  periodEnd                 DateTime  @map("period_end")
  status                    String    @default("pending") @db.VarChar(20)
  paidAt                    DateTime? @map("paid_at")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @default(now()) @updatedAt @map("updated_at")

  coach                     CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  subscription              Subscription @relation(fields: [studentSubscriptionId], references: [id])

  @@map("coach_commissions")
}

